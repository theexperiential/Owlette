rules_version = '2';

// Owlette Firestore Security Rules
// Version: 2.0.0
// Last Updated: 2025-11-02
//
// Security Model:
// - Role-based access control (RBAC): user | admin
// - All authenticated users can access sites (trust-based)
// - Service accounts (agents) have admin access to write machine data
// - Admins can manage users and upload installer versions
// - Unauthenticated users can read installer_metadata (for public downloads)
//
// Key Features:
// - Admin Panel: User management, installer version management
// - Public Downloads: Anyone can download agent installers
// - Site Access: All authenticated users can manage their sites
// - Command System: Bidirectional communication with agents

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // Helper Functions
    // ============================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is admin (has role='admin' in users collection)
    function isAdmin() {
      return request.auth != null &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Check if request is from service account (Python agent)
    // Service accounts have the 'admin' claim set to true
    function isServiceAccount() {
      return request.auth != null &&
             request.auth.token.admin == true;
    }

    // Check if user has access to a site
    // Current: Trust all authenticated users
    // Future: Check user.sites array contains siteId
    function canAccessSite(siteId) {
      return isAuthenticated();
    }

    // Validate that required fields are present in write operations
    function hasRequiredFields(required) {
      return request.resource.data.keys().hasAll(required);
    }

    // ============================================
    // Sites Collection
    // ============================================

    match /sites/{siteId} {
      // Site document access
      allow read: if canAccessSite(siteId);
      allow create: if isAuthenticated(); // Any authenticated user can create a site
      allow update, delete: if canAccessSite(siteId);

      // ----------------------------------------
      // Machines Subcollection
      // ----------------------------------------

      match /machines/{machineId} {
        // Machine status document
        // Agents write heartbeats, metrics, and process status
        // Web dashboard reads machine status
        allow read: if canAccessSite(siteId) || isServiceAccount();
        allow write: if isServiceAccount(); // Only agents can write machine data

        // Commands documents (pending/completed)
        // Web dashboard writes pending commands
        // Agents read pending and write completed
        match /commands/{commandDoc} {
          allow read: if canAccessSite(siteId) || isServiceAccount();
          allow write: if canAccessSite(siteId) || isServiceAccount();
        }
      }

      // ----------------------------------------
      // Deployments Subcollection
      // ----------------------------------------

      match /deployments/{deploymentId} {
        // Software installation deployments
        // Web dashboard creates and manages deployments
        allow read: if canAccessSite(siteId);
        allow create: if canAccessSite(siteId) &&
                         hasRequiredFields(['name', 'installer_name', 'targets', 'status', 'createdAt']);
        allow update: if canAccessSite(siteId);
        allow delete: if canAccessSite(siteId);
      }

      // ----------------------------------------
      // Installer Templates Subcollection
      // ----------------------------------------

      match /installer_templates/{templateId} {
        // Reusable installer templates
        // Web dashboard manages templates
        allow read: if canAccessSite(siteId);
        allow create: if canAccessSite(siteId) &&
                         hasRequiredFields(['name', 'installer_name', 'createdAt']);
        allow update, delete: if canAccessSite(siteId);
      }

      // ----------------------------------------
      // Project Templates Subcollection
      // ----------------------------------------

      match /project_templates/{templateId} {
        // Reusable project distribution templates
        // Web dashboard manages templates
        allow read: if canAccessSite(siteId);
        allow create: if canAccessSite(siteId) &&
                         hasRequiredFields(['name', 'file_name', 'createdAt']);
        allow update, delete: if canAccessSite(siteId);
      }

      // ----------------------------------------
      // Project Distributions Subcollection
      // ----------------------------------------

      match /project_distributions/{distributionId} {
        // Project file distributions
        // Web dashboard creates and manages distributions
        allow read: if canAccessSite(siteId);
        allow create: if canAccessSite(siteId) &&
                         hasRequiredFields(['name', 'file_name', 'targets', 'status', 'createdAt']);
        allow update: if canAccessSite(siteId);
        allow delete: if canAccessSite(siteId);
      }
    }

    // ============================================
    // Config Collection
    // ============================================

    match /config/{siteId}/machines/{machineId} {
      // Machine configuration (process lists, settings)
      // Web dashboard writes config updates
      // Agents read config and write initial config on first startup
      allow read: if canAccessSite(siteId) || isServiceAccount();
      allow write: if canAccessSite(siteId) || isServiceAccount();
    }

    // ============================================
    // Users Collection (Admin System)
    // ============================================

    match /users/{userId} {
      // User profiles with role and site access
      // Users can read their own document
      // Admins can read and write all user documents (for role management)
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow write: if isAdmin(); // Only admins can create/update/delete users
    }

    // ============================================
    // Installer Metadata Collection (Admin System)
    // ============================================

    match /installer_metadata/{document=**} {
      // Agent installer versions and metadata
      // PUBLIC READ: Anyone can download installers (unauthenticated allowed)
      // ADMIN WRITE: Only admins can upload/modify installer versions
      allow read: if true;  // Public read for download button
      allow write: if isAdmin();  // Only admins can manage installers
    }

    // ============================================
    // Deny All Other Paths
    // ============================================

    // Explicitly deny access to any other documents
    // This prevents accidental data leaks
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
