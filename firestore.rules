rules_version = '2';

// Owlette Firestore Security Rules
// Version: 2.2.0 - Multi-User Site Access Control
// Last Updated: 2025-11-05
//
// Security Model:
// - Role-based access control (RBAC): user | admin | agent
// - Multi-user site access: Users can only access sites in their assigned sites array
// - Admins can access ALL sites regardless of assignment
// - Agents use custom tokens (OAuth) with site-scoped permissions
// - Agents can ONLY access their assigned site and machine (strict isolation)
// - Admins can manage users, assign sites, and upload installer versions
// - Unauthenticated users can read installer_metadata (for public downloads)
//
// Key Features:
// - OAuth Authentication: Agents authenticate via custom tokens (no service accounts)
// - Scoped Permissions: Agents limited to their site_id + machine_id (from token claims)
// - Admin Panel: User management, site assignment, installer version management
// - Public Downloads: Anyone can download agent installers
// - Site Access: Users can only access sites they're assigned to (admins see all)
// - Command System: Bidirectional communication with agents
//
// Custom Token Claims (for agents):
// - role: 'agent' (identifies agent authentication)
// - site_id: 'site_xxx' (which site this agent belongs to - snake_case!)
// - machine_id: 'DESKTOP-001' (which machine this agent represents - snake_case!)
//
// IMPORTANT: Claim names must be snake_case (site_id, machine_id) NOT camelCase!
// Firebase custom token claims are used in security rules exactly as provided.

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // Helper Functions
    // ============================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is admin (has role='admin' in users collection)
    function isAdmin() {
      return request.auth != null &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Check if request is from service account (Python agent)
    // Service accounts have the 'admin' claim set to true
    // DEPRECATED: Use isAgent() for OAuth-authenticated agents
    function isServiceAccount() {
      return request.auth != null &&
             request.auth.token.admin == true;
    }

    // Check if request is from OAuth-authenticated agent
    // Agents have custom token with claims: {role: 'agent', site_id: 'xxx', machine_id: 'yyy'}
    function isAgent() {
      return request.auth != null &&
             request.auth.token.role == 'agent' &&
             request.auth.token.site_id is string &&
             request.auth.token.machine_id is string;
    }

    // Check if agent has access to a specific site
    // Agents can ONLY access their assigned site (from token claim)
    function agentCanAccessSite(siteId) {
      return isAgent() && request.auth.token.site_id == siteId;
    }

    // Check if agent is accessing their own machine
    // Prevents agents from accessing other machines (even in same site)
    function agentCanAccessMachine(siteId, machineId) {
      return isAgent() &&
             request.auth.token.site_id == siteId &&
             request.auth.token.machine_id == machineId;
    }

    // Check if user has access to a site
    // Admins can access all sites
    // Regular users can only access sites in their assigned sites array
    // Returns false if user document doesn't exist (graceful handling for new users)
    function canAccessSite(siteId) {
      return isAuthenticated() && (
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
         siteId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.sites)
      );
    }

    // Validate that required fields are present in write operations
    function hasRequiredFields(required) {
      return request.resource.data.keys().hasAll(required);
    }

    // ============================================
    // Sites Collection
    // ============================================

    match /sites/{siteId} {
      // Site document access
      // READ: Allow any authenticated user to check if site exists (for availability checking during creation)
      // UPDATE/DELETE: Only users with access to the site
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // Any authenticated user can create a site
      allow update, delete: if canAccessSite(siteId);

      // ----------------------------------------
      // Machines Subcollection
      // ----------------------------------------

      match /machines/{machineId} {
        // Machine status document
        // Agents write heartbeats, metrics, and process status
        // Web dashboard reads machine status
        // OAuth agents can ONLY access their own machine (strict isolation)
        allow read: if canAccessSite(siteId) ||
                       isServiceAccount() ||
                       agentCanAccessMachine(siteId, machineId);
        allow write: if isServiceAccount() ||
                        agentCanAccessMachine(siteId, machineId); // Only the assigned agent can write
        allow delete: if canAccessSite(siteId); // Authenticated users can remove machines from sites

        // Commands documents (pending/completed)
        // Web dashboard writes pending commands
        // Agents read pending and write completed
        // OAuth agents can ONLY access commands for their own machine
        match /commands/{commandDoc} {
          allow read: if canAccessSite(siteId) ||
                         isServiceAccount() ||
                         agentCanAccessMachine(siteId, machineId);
          allow write: if canAccessSite(siteId) ||
                          isServiceAccount() ||
                          agentCanAccessMachine(siteId, machineId);
          allow delete: if canAccessSite(siteId); // Authenticated users can delete commands
        }

        // Installed Software Inventory Subcollection
        // Agents write software inventory data
        // Web dashboard reads to display installed software
        // OAuth agents can ONLY write to their own machine's inventory
        match /installed_software/{softwareId} {
          allow read: if canAccessSite(siteId) ||
                         isServiceAccount() ||
                         agentCanAccessMachine(siteId, machineId);
          allow write: if isServiceAccount() ||
                          agentCanAccessMachine(siteId, machineId); // Only agents can write inventory
          allow delete: if canAccessSite(siteId) ||
                           isServiceAccount() ||
                           agentCanAccessMachine(siteId, machineId); // Allow cleanup
        }
      }

      // ----------------------------------------
      // Deployments Subcollection
      // ----------------------------------------

      match /deployments/{deploymentId} {
        // Software installation deployments
        // Web dashboard creates and manages deployments
        allow read: if canAccessSite(siteId);
        allow create: if canAccessSite(siteId) &&
                         hasRequiredFields(['name', 'installer_name', 'targets', 'status', 'createdAt']);
        allow update: if canAccessSite(siteId);
        allow delete: if canAccessSite(siteId);
      }

      // ----------------------------------------
      // Installer Templates Subcollection
      // ----------------------------------------

      match /installer_templates/{templateId} {
        // Reusable installer templates
        // Web dashboard manages templates
        allow read: if canAccessSite(siteId);
        allow create: if canAccessSite(siteId) &&
                         hasRequiredFields(['name', 'installer_name', 'createdAt']);
        allow update, delete: if canAccessSite(siteId);
      }

      // ----------------------------------------
      // Project Templates Subcollection
      // ----------------------------------------

      match /project_templates/{templateId} {
        // Reusable project distribution templates
        // Web dashboard manages templates
        allow read: if canAccessSite(siteId);
        allow create: if canAccessSite(siteId) &&
                         hasRequiredFields(['name', 'file_name', 'createdAt']);
        allow update, delete: if canAccessSite(siteId);
      }

      // ----------------------------------------
      // Project Distributions Subcollection
      // ----------------------------------------

      match /project_distributions/{distributionId} {
        // Project file distributions
        // Web dashboard creates and manages distributions
        allow read: if canAccessSite(siteId);
        allow create: if canAccessSite(siteId) &&
                         hasRequiredFields(['name', 'file_name', 'targets', 'status', 'createdAt']);
        allow update: if canAccessSite(siteId);
        allow delete: if canAccessSite(siteId);
      }
    }

    // ============================================
    // Config Collection
    // ============================================

    match /config/{siteId}/machines/{machineId} {
      // Machine configuration (process lists, settings)
      // Web dashboard writes config updates
      // Agents read config and write initial config on first startup
      // OAuth agents can ONLY access config for their own machine
      allow read: if canAccessSite(siteId) ||
                     isServiceAccount() ||
                     agentCanAccessMachine(siteId, machineId);
      allow write: if canAccessSite(siteId) ||
                      isServiceAccount() ||
                      agentCanAccessMachine(siteId, machineId);
      allow delete: if canAccessSite(siteId); // Authenticated users can delete machine config
    }

    // ============================================
    // Users Collection (Admin System)
    // ============================================

    match /users/{userId} {
      // User profiles with role and site access
      // Users can read their own document
      // Admins can read and write all user documents (for role management)
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());

      // Users can create their own document (on first login)
      allow create: if request.auth.uid == userId;

      // Users can update their own sites array (when creating sites)
      // But cannot change their role or other sensitive fields
      allow update: if request.auth.uid == userId &&
                       request.resource.data.role == resource.data.role &&
                       request.resource.data.email == resource.data.email;

      // Only admins can delete users or update other users
      allow write: if isAdmin();
    }

    // ============================================
    // Installer Metadata Collection (Admin System)
    // ============================================

    match /installer_metadata/{document=**} {
      // Agent installer versions and metadata
      // PUBLIC READ: Anyone can download installers (unauthenticated allowed)
      // ADMIN WRITE: Only admins can upload/modify installer versions
      allow read: if true;  // Public read for download button
      allow write: if isAdmin();  // Only admins can manage installers
    }

    // ============================================
    // System Presets Collection
    // ============================================

    match /system_presets/{presetId} {
      // Global software deployment presets (Owlette Agent, TouchDesigner, etc.)
      // READ: All authenticated users can see presets
      // WRITE: Only admins can create/update/delete presets
      allow read: if isAuthenticated();

      // Create requires all essential fields
      allow create: if isAdmin() &&
                       hasRequiredFields(['name', 'software_name', 'category',
                                         'installer_name', 'silent_flags', 'order', 'createdAt']);

      // Update and delete: admin only
      allow update, delete: if isAdmin();
    }

    // ============================================
    // OAuth Token Collections (Server-Side Only)
    // ============================================

    match /agent_tokens/{tokenId} {
      // Registration codes for agent installer OAuth flow
      // SECURITY: Only accessible via server-side Admin SDK
      // Never allow client-side access (prevents token theft)
      allow read, write: if false;
    }

    match /agent_refresh_tokens/{tokenHash} {
      // Refresh tokens for agent authentication
      // SECURITY: Only accessible via server-side Admin SDK
      // Tokens are stored hashed for additional security
      allow read, write: if false;
    }

    // ============================================
    // Deny All Other Paths
    // ============================================

    // Explicitly deny access to any other documents
    // This prevents accidental data leaks
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
